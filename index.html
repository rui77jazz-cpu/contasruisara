<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Contas Partilhadas ‚Äî Sara & Rui</title>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <style>
    /* (estilos id√™nticos aos que usavas, ligeira compacta√ß√£o) */
    :root{--primary:#5a67d8;--accent:#38a169;--danger:#e53e3e;--text:#2d3748;--muted:#4a5568;--bg:#edf2f7;--card:#fff;--border:#e2e8f0;--r:0.5rem;--gap:1rem}
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Inter,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--muted);padding:1.5rem}
    .app{max-width:820px;margin:0 auto;background:var(--card);padding:2rem;border-radius:var(--r);box-shadow:0 10px 15px -3px rgba(0,0,0,.08),0 4px 6px -2px rgba(0,0,0,.04)}
    h1{color:var(--primary);text-align:center;margin-bottom:1.5rem;font-size:2rem}
    section{margin-bottom:1.25rem}
    h2{color:var(--text);font-size:1.25rem;margin-bottom:.75rem;border-bottom:1px solid var(--border);padding-bottom:.4rem}
    form#expenseForm{display:grid;grid-template-columns:1fr;gap:1rem}
    @media(min-width:700px){form#expenseForm{grid-template-columns:1fr 1fr 1fr}form#expenseForm button{grid-column:1/-1}}
    label{font-weight:600;color:var(--text);display:flex;flex-direction:column;gap:.35rem}
    input,select{padding:.65rem 1rem;border:1px solid var(--border);border-radius:var(--r);font-size:1rem}
    button[type=submit]{padding:1rem;background:var(--accent);color:#fff;border-radius:var(--r);border:0;cursor:pointer;font-weight:700}
    #clearAllBtn{background:var(--danger);color:#fff;border:0;padding:.75rem;border-radius:var(--r);cursor:pointer;margin-bottom:.75rem}
    #loading-status{padding:.75rem;background:var(--bg);border:1px solid var(--border);border-radius:var(--r);font-style:italic;color:var(--muted)}
    .expense-item{padding:1rem;border:1px solid var(--border);border-radius:var(--r);display:flex;flex-direction:column;gap:.5rem;background:var(--card)}
    .expense-item p{display:flex;justify-content:space-between;align-items:center}
    .expense-item .description{font-style:italic;color:var(--muted)}
    .expense-item button{background:var(--danger);color:#fff;border:0;padding:.45rem .7rem;border-radius:6px;cursor:pointer}
    #settlements{padding:.75rem;border-radius:var(--r);margin-top:.5rem}
  </style>
</head>
<body>
  <div class="app">
    <h1>Contas Partilhadas ‚Äî Sara &amp; Rui</h1>

    <section>
      <h2>‚ûï Adicionar Nova Despesa</h2>
      <form id="expenseForm">
        <label>Quem pagou:
          <select id="payer" required>
            <option value="" disabled selected>Selecione o pagador</option>
            <option value="Sara">Sara</option>
            <option value="Rui">Rui</option>
          </select>
        </label>

        <label>Quantia (‚Ç¨):
          <input id="amount" type="number" step="0.01" min="0.01" placeholder="Ex: 25.50" required />
        </label>

        <label>Descri√ß√£o:
          <input id="description" type="text" maxlength="100" placeholder="Ex: Jantar" required />
        </label>

        <button type="submit">Guardar Despesa</button>
      </form>
    </section>

    <hr />

    <section>
      <h2>üßæ Despesas Registadas</h2>
      <button id="clearAllBtn">üö® Limpar Todas as Despesas</button>
      <p id="loading-status">A carregar despesas...</p>
      <div id="list"></div>
    </section>

    <hr />

    <section>
      <h2>üìä Resumo do Saldo</h2>
      <p><strong>Sara (Pagou):</strong> <span id="balanceSara">0.00</span> ‚Ç¨</p>
      <p><strong>Rui (Pagou):</strong> <span id="balanceRui">0.00</span> ‚Ç¨</p>
      <p class="total-summary"><strong>Total Geral:</strong> <span id="totalSum">0.00</span> ‚Ç¨</p>
      <h3>Acerto de Contas Sugerido:</h3>
      <div id="settlements">A calcular balan√ßo...</div>
    </section>
  </div>

  <script>
    // ----------------------
    // Configura√ß√µes Firebase
    // ----------------------
    const firebaseConfig = {
      apiKey: "AIzaSyCle9Kx3OVD7mnZfXubKyIGW6COYrGI304",
      authDomain: "contassararui.firebaseapp.com",
      projectId: "contassararui",
      storageBucket: "contassararui.firebasestorage.app",
      messagingSenderId: "760330070358",
      appId: "1:760330070358:web:5d1f213133bfdbe902cef7"
    };

    // Inicializar Firebase compat
    if (typeof firebase !== 'undefined' && firebase.initializeApp) {
      try {
        firebase.initializeApp(firebaseConfig);
        var db = firebase.firestore();
        console.log('Firebase inicializado (compat).');
      } catch (e) {
        console.warn('Erro inicializar Firebase (provavelmente j√° inicializado):', e);
      }
    } else {
      console.warn('SDK Firebase n√£o encontrado ‚Äî a aplica√ß√£o ir√° funcionar apenas com localStorage.');
      db = null;
    }

    // ----------------------
    // Fallback: localStorage
    // ----------------------
    function loadLocal() {
      try {
        const raw = localStorage.getItem('expenses');
        return raw ? JSON.parse(raw) : [];
      } catch (e) { console.error(e); return []; }
    }
    function saveLocal(list) {
      try { localStorage.setItem('expenses', JSON.stringify(list)); } catch(e){console.error(e);} }

    // ----------------------
    // Estado local
    // ----------------------
    let expenses = [];
    const HOUSEHOLD_DOC = 'sara_rui';

    // Render UI
    function render() {
      const list = document.getElementById('list');
      list.innerHTML = '';
      const loading = document.getElementById('loading-status');
      const clearBtn = document.getElementById('clearAllBtn');

      if (!expenses || expenses.length === 0) {
        loading.textContent = 'Nenhuma despesa registada ainda.';
        loading.style.display = 'block';
        clearBtn.style.display = 'none';
      } else {
        loading.style.display = 'none';
        clearBtn.style.display = 'block';
      }

      expenses.forEach((e, i) => {
        const div = document.createElement('div');
        div.className = 'expense-item';
        const amount = parseFloat(e.amount).toFixed(2);
        const date = e.date || new Date().toLocaleDateString('pt-PT');
        div.innerHTML = `
          <p><span><strong>${e.payer}</strong> pagou <strong>${amount}‚Ç¨</strong></span> <span class="expense-date">üóìÔ∏è ${date}</span></p>
          <p class="description">${e.description}</p>
          <button data-i="${i}">Remover</button>
        `;
        const btn = div.querySelector('button');
        btn.addEventListener('click', () => removeExpense(i));
        list.appendChild(div);
      });

      updateTotals();
    }

    function updateTotals(){
      let sara=0, rui=0, total=0;
      expenses.forEach(e=>{
        const a = parseFloat(e.amount) || 0; total += a;
        if (e.payer==='Sara') sara+=a; else if (e.payer==='Rui') rui+=a;
      });
      document.getElementById('balanceSara').textContent = sara.toFixed(2);
      document.getElementById('balanceRui').textContent = rui.toFixed(2);
      document.getElementById('totalSum').textContent = total.toFixed(2);
      const diff = sara - rui; const settle = document.getElementById('settlements');
      if (Math.abs(diff)<0.01){ settle.textContent='Tudo equilibrado.'; settle.className=''; }
      else if (diff>0){ settle.textContent = `Rui deve pagar ${diff.toFixed(2)}‚Ç¨ √† Sara.`; settle.className=''; }
      else { settle.textContent = `Sara deve pagar ${(-diff).toFixed(2)}‚Ç¨ ao Rui.`; settle.className=''; }
    }

    // ----------------------
    // CRUD: Firestore ou local
    // ----------------------
    async function addExpenseObj(obj){
      if (db) {
        try {
          await db.collection('households').doc(HOUSEHOLD_DOC).collection('expenses').add(obj);
          // Firestore listener actualizar√° a lista
          return;
        } catch(e){
          console.error('Erro a gravar no Firestore:', e);
          alert('N√£o foi poss√≠vel gravar no Firebase. A despesa ser√° guardada localmente.');
        }
      }
      // fallback local
      expenses.unshift(obj);
      saveLocal(expenses);
      render();
    }

    async function removeExpense(index){
      // Se estiver ligado ao Firestore, tentamos apagar pelo id quando poss√≠vel
      const item = expenses[index];
      if (!item) return;

      if (db && item._id) {
        try {
          await db.collection('households').doc(HOUSEHOLD_DOC).collection('expenses').doc(item._id).delete();
          return;
        } catch(e){ console.warn('Erro apagar no Firestore:', e); }
      }

      // fallback: apagar local
      if (!confirm('Tem certeza que deseja remover esta despesa?')) return;
      expenses.splice(index,1);
      saveLocal(expenses);
      render();
    }

    async function clearAllExpenses(){
      if (!confirm('üö® ATEN√á√ÉO: Apagar todas as despesas?')) return;
      if (db) {
        // apagar todos os docs da cole√ß√£o (cuidado com regras / custos)
        try {
          const collRef = db.collection('households').doc(HOUSEHOLD_DOC).collection('expenses');
          const snap = await collRef.get();
          const batch = db.batch();
          snap.forEach(d => batch.delete(d.ref));
          await batch.commit();
        } catch(e){ console.error(e); alert('N√£o foi poss√≠vel apagar tudo no Firestore.'); }
      }
      // limpar local
      expenses = [];
      saveLocal(expenses);
      render();
    }
    window.clearAllExpenses = clearAllExpenses; // expor p/ bot√£o inline

    // ----------------------
    // Listener Firestore para updates em tempo real
    // ----------------------
    function startFirestoreListener(){
      if (!db) return;
      try{
        db.collection('households').doc(HOUSEHOLD_DOC).collection('expenses')
          .orderBy('date','desc')
          .onSnapshot(snap=>{
            const arr = [];
            snap.forEach(doc=>{ const d = doc.data(); d._id = doc.id; arr.push(d); });
            // Se temos dados no Firestore usamos estes como fonte da verdade
            expenses = arr;
            saveLocal(expenses); // manter fallback actualizado
            render();
          }, err=>{ console.error('onSnapshot erro:', err); });
      }catch(e){ console.error('Erro a criar listener:', e); }
    }

    // ----------------------
    // Form submit
    // ----------------------
    document.getElementById('expenseForm').addEventListener('submit', async function(ev){
      ev.preventDefault();
      const payer = document.getElementById('payer').value;
      const amount = parseFloat(document.getElementById('amount').value);
      const description = document.getElementById('description').value.trim();
      const dateISO = new Date().toISOString().slice(0,10);

      if (!payer){ alert('Selecione o pagador.'); return; }
      if (!amount || amount <= 0){ alert('Quantia inv√°lida.'); return; }
      if (!description){ alert('Adicione uma descri√ß√£o.'); return; }

      const obj = { payer, amount: Math.round(amount*100)/100, date: dateISO, description };
      await addExpenseObj(obj);

      // resetar
      this.reset();
      document.getElementById('payer').value = '';
    });

    // ----------------------
    // Inicializa√ß√£o
    // ----------------------
    (function init(){
      // Ler local para iniciar
      expenses = loadLocal();
      render();

      // se Firestore dispon√≠vel, iniciar listener
      if (db) startFirestoreListener();

      // ligar bot√£o limpar
      document.getElementById('clearAllBtn').addEventListener('click', clearAllExpenses);
    })();
  </script>
</body>
</html>

